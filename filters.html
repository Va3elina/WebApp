<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Filtereinstellungen</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
      background-color: var(--bg-color, white);
      color: var(--text-color, black);
    }
    #map {
      height: 400px;
      width: 100%;
      margin-bottom: 20px;
      border: 1px solid #ccc;
    }
    .slider-container {
      margin: 15px 0;
    }
    .slider-container label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .slider-values {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    button {
      background-color: var(--button-color, #007bff);
      color: var(--button-text-color, white);
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      transition: transform 0.1s ease-in-out;
    }
    button:active {
      transform: scale(0.98);
    }
    button:hover {
      background-color: #0056b3;
    }
    .noUi-handle {
      background-color: #007bff !important;
      border: none !important;
    }
    .noUi-connect {
      background-color: #007bff !important;
    }
    .noUi-base {
      background-color: #e5e5e5 !important;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.78.0/L.Control.Locate.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.78.0/L.Control.Locate.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css" />
</head>
<body>
  <h1>Filtereinstellungen</h1>
  <div id="map"></div>
  <div class="slider-container">
    <label for="price-range">Preisbereich (€):</label>
    <div id="price-range"></div>
    <div class="slider-values">
      <span id="price-min">0</span>
      <span id="price-max">3000</span>
    </div>
  </div>
  <div class="slider-container">
    <label for="size-range">Größenbereich (m²):</label>
    <div id="size-range"></div>
    <div class="slider-values">
      <span id="size-min">10</span>
      <span id="size-max">100</span>
    </div>
  </div>
  <label>
    <input type="checkbox" id="temporary" checked> Zwischenmiete einbeziehen
  </label>
  <button id="save" style="margin-top: 15px">Filter speichern</button>
  <script>
    const tg = window.Telegram.WebApp;

    tg.expand();
    function applyTheme() {
      const theme = tg.themeParams;
      document.body.style.setProperty("--bg-color", theme.bg_color || "white");
      document.body.style.setProperty("--text-color", theme.text_color || "black");
      document.querySelector("button").style.backgroundColor = theme.button_color || "#007bff";
      document.querySelector("button").style.color = theme.button_text_color || "white";
    }
    applyTheme();

    Telegram.WebApp.onEvent('themeChanged', applyTheme);

    const map = L.map('map').setView([51.1657, 10.4515], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: {
        polygon: true,
        rectangle: true,
        circle: true,
        polyline: false,
        marker: false
      },
      edit: {
        featureGroup: drawnItems
      }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (event) {
      const layer = event.layer;
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);
    });

    L.control.locate({
      position: 'topleft',
      strings: {
        title: "Zeige mir meine Position"
      }
    }).addTo(map);

    map.locate({ setView: true, maxZoom: 16 });
    map.on('locationerror', () => {
      console.warn("Геолокация недоступна. Используется стандартное положение.");
    });

    const priceSlider = document.getElementById('price-range');
    noUiSlider.create(priceSlider, {
      start: [1000, 3000],
      connect: true,
      range: { min: 0, max: 5000 }
    });
    priceSlider.noUiSlider.on('update', values => {
      document.getElementById('price-min').textContent = Math.round(values[0]);
      document.getElementById('price-max').textContent = Math.round(values[1]);
    });

    const sizeSlider = document.getElementById('size-range');
    noUiSlider.create(sizeSlider, {
      start: [20, 100],
      connect: true,
      range: { min: 10, max: 200 }
    });
    sizeSlider.noUiSlider.on('update', values => {
      document.getElementById('size-min').textContent = Math.round(values[0]);
      document.getElementById('size-max').textContent = Math.round(values[1]);
    });

    document.getElementById('save').addEventListener('click', () => {
      const filters = {
        price: priceSlider.noUiSlider.get(),
        size: sizeSlider.noUiSlider.get(),
        temporary: document.getElementById('temporary').checked
      };
      tg.sendData(JSON.stringify(filters));
      tg.close();
    });
  </script>
</body>
</html>
