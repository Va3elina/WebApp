<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Filtereinstellungen</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.78.0/L.Control.Locate.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.78.0/L.Control.Locate.min.css" />

  <style>
    :root {
      --tg-bg-color: #ffffff;
      --tg-text-color: #000000;
      --tg-hint-color: #707579;
      --tg-link-color: #007bff;
      --tg-button-color: #007bff;
      --tg-button-text-color: #ffffff;
      --tg-secondary-bg: #f5f5f5;
      --tg-border-color: #cccccc;
      
      --input-bg: var(--tg-secondary-bg);
      --input-text: var(--tg-text-color);
      --input-border: var(--tg-border-color);
      
      --suggestions-bg: var(--input-bg);
      --suggestions-text: var(--tg-text-color);
      --suggestions-hover: #e0e0e0;
      --suggestions-border: var(--tg-border-color);
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: var(--tg-bg-color);
      color: var(--tg-text-color);
      transition: background-color 0.3s, color 0.3s;
      margin: 0;
    }

    #map {
      height: 400px;
      width: 100%;
      margin-bottom: 20px;
      border-radius: 12px;
      overflow: hidden;
    }

    .input-range {
      margin: 15px 0;
    }

    .range-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .range-row input[type="number"] {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--input-border);
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--input-text);
      font-size: 14px;
    }

    button {
      background-color: var(--tg-button-color);
      color: var(--tg-button-text-color);
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: opacity 0.2s;
      margin: 5px 0;
    }

    button:hover {
      opacity: 0.9;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 5px;
      border-radius: 12px;
      border: 1px solid var(--input-border);
      background-color: var(--input-bg);
      color: var(--input-text);
      font-size: 14px;
      box-sizing: border-box;
    }

    .suggestions {
      position: absolute;
      width: calc(100% - 16px);
      background: var(--suggestions-bg);
      color: var(--suggestions-text);
      border: 1px solid var(--suggestions-border);
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-top: -5px;
    }

    .suggestion {
      padding: 12px 15px;
      cursor: pointer;
      color: var(--suggestions-text);
      background-color: var(--suggestions-bg);
      user-select: none;
      transition: background-color 0.2s;
      border-bottom: 1px solid var(--tg-border-color);
    }

    .suggestion:last-child {
      border-bottom: none;
    }

    .suggestion:hover {
      background-color: var(--suggestions-hover);
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: var(--tg-text-color);
      font-size: 14px;
    }

    select {
      background-color: var(--input-bg);
      color: var(--input-text);
      border: 1px solid var(--input-border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      height: 40px;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
    }

    h1 {
      color: var(--tg-text-color);
      font-size: 24px;
      margin-top: 0;
      margin-bottom: 20px;
    }

    h3 {
      color: var(--tg-text-color);
      font-size: 18px;
      margin-bottom: 15px;
    }

    #options {
      margin: 20px 0;
    }

    #options label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      cursor: pointer;
    }

    #options input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--tg-button-color);
    }

    #websites label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      cursor: pointer;
    }

    #websites input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--tg-button-color);
    }

    .leaflet-draw-toolbar a {
      background-color: var(--tg-button-color) !important;
      color: white !important;
    }

    .leaflet-draw-toolbar a:hover {
      background-color: var(--tg-button-color) !important;
      opacity: 0.9 !important;
    }
  </style>
</head>
<body>
<h1>Filtereinstellungen</h1>

<div style="position: relative;">
  <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 15px;">
    <input type="text" id="city" placeholder="z.B. Berlin" autocomplete="off">
    <select id="radius" style="width: 100px;">
      <option value="5">5 km</option>
      <option value="10" selected>10 km</option>
      <option value="15">15 km</option>
      <option value="20">20 km</option>
      <option value="30">30 km</option>
    </select>
  </div>
  <div id="city-suggestions" class="suggestions" style="display: none;"></div>
</div>

<button onclick="searchCity()">Karte aktualisieren</button>

<div id="map"></div>

<div class="input-range">
  <label>Preisbereich, €:</label>
  <div class="range-row">
    <input type="number" id="price-min" placeholder="Min">
    <span style="color: var(--tg-text-color)">–</span>
    <input type="number" id="price-max" placeholder="Max">
  </div>
</div>

<div class="input-range">
  <label>Größenbereich, м²:</label>
  <div class="range-row">
    <input type="number" id="size-min" placeholder="Min">
    <span style="color: var(--tg-text-color)">–</span>
    <input type="number" id="size-max" placeholder="Max">
  </div>
</div>

<div id="options">
  <label><input type="checkbox" id="tauschwohnung"> Tauschwohnungen</label>
  <label><input type="checkbox" id="wbs"> WBS erforderlich</label>
</div>

<h3>Websites</h3>
<div id="websites">
  <label><input type="checkbox" value="immobilienscout24" checked> ImmobilienScout24.de</label>
  <label><input type="checkbox" value="kleinanzeigen" checked> Kleinanzeigen.de</label>
  <label><input type="checkbox" value="immowelt" checked> Immowelt.de</label>
</div>

<button id="save" style="margin-top: 25px;">Filter speichern</button>

<script>
  // Инициализация Telegram WebApp
  const tg = window.Telegram.WebApp;
  tg.expand();
  
  // Функция применения темы
  function applyTheme() {
    const theme = tg.themeParams;
    
    // Основные цвета
    document.documentElement.style.setProperty('--tg-bg-color', theme.bg_color || '#ffffff');
    document.documentElement.style.setProperty('--tg-text-color', theme.text_color || '#000000');
    document.documentElement.style.setProperty('--tg-hint-color', theme.hint_color || '#707579');
    document.documentElement.style.setProperty('--tg-link-color', theme.link_color || '#007bff');
    document.documentElement.style.setProperty('--tg-button-color', theme.button_color || '#007bff');
    document.documentElement.style.setProperty('--tg-button-text-color', theme.button_text_color || '#ffffff');
    
    // Определение темной темы
    const bgColor = theme.bg_color || '#ffffff';
    const rgb = parseInt(bgColor.substring(1), 16);
    const r = (rgb >> 16) & 0xff;
    const g = (rgb >> 8) & 0xff;
    const b = (rgb >> 0) & 0xff;
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    const isDark = brightness < 128;
    
    // Производные цвета
    document.documentElement.style.setProperty('--tg-secondary-bg', isDark ? '#333333' : '#f5f5f5');
    document.documentElement.style.setProperty('--tg-border-color', isDark ? '#555555' : '#cccccc');
    document.documentElement.style.setProperty('--suggestions-hover', isDark ? '#444444' : '#e0e0e0');
    
    // Обновление элементов управления картой
    if (window.L) {
      const mapStyle = document.createElement('style');
      mapStyle.textContent = 
        .leaflet-control {
          background-color: ${isDark ? '#333' : '#fff'} !important;
          color: ${isDark ? '#fff' : '#000'} !important;
        }
        .leaflet-control-attribution {
          background-color: ${isDark ? 'rgba(0,0,0,0.7)' : 'rgba(255,255,255,0.7)'} !important;
          color: ${isDark ? '#fff' : '#000'} !important;
        }
      ;
      document.head.appendChild(mapStyle);
    }
  }

  // Обработчик изменения темы
  tg.onEvent('themeChanged', applyTheme);
  applyTheme();

  // Инициализация карты
  const map = L.map('map').setView([51.1657, 10.4515], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Элементы рисования на карте
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    draw: {
      polygon: true,
      rectangle: false,
      circle: true,
      polyline: false,
      marker: false,
      circlemarker: false
    },
    edit: {
      featureGroup: drawnItems
    }
  });
  map.addControl(drawControl);

  map.on(L.Draw.Event.CREATED, function(e) {
    drawnItems.clearLayers();
    drawnItems.addLayer(e.layer);
  });

  // Поиск городов
  const GEOAPIFY_KEY = "39e8705206714ca5bfe88799d07ef7e1";
  let debounceTimer;

  function normalize(str) {
    return str.toLowerCase()
      .replace(/ä/g, 'ae')
      .replace(/ö/g, 'oe')
      .replace(/ü/g, 'ue')
      .replace(/ß/g, 'ss')
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  document.getElementById("city").addEventListener("input", function() {
    clearTimeout(debounceTimer);
    const query = this.value.trim();
    
    if (query.length < 2) {
      document.getElementById("city-suggestions").style.display = "none";
      return;
    }

    debounceTimer = setTimeout(() => {
      fetch(https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(query)}&lang=de&filter=countrycode:de&limit=5&apiKey=${GEOAPIFY_KEY})
        .then(response => response.json())
        .then(data => {
          const container = document.getElementById("city-suggestions");
          container.innerHTML = "";
          
          if (data.features && data.features.length > 0) {
            data.features.forEach(feature => {
              const city = feature.properties.city || feature.properties.town || feature.properties.village;
              if (!city) return;
              
              const div = document.createElement("div");
              div.className = "suggestion";
              div.textContent = city;
              div.addEventListener("click", () => {
                document.getElementById("city").value = city;
                container.style.display = "none";
                const [lon, lat] = feature.geometry.coordinates;
                map.setView([lat, lon], 13);
                updateCircle(lat, lon);
              });
              container.appendChild(div);
            });
            container.style.display = "block";
          } else {
            const noResults = document.createElement("div");
            noResults.className = "suggestion";
            noResults.textContent = "Keine Ergebnisse gefunden";
            container.appendChild(noResults);
            container.style.display = "block";
          }
          
          // Применяем текущую тему к новым элементам
          applyTheme();
        })
        .catch(error => {
          console.error("Error fetching city suggestions:", error);
        });
    }, 300);
  });

  // Закрытие выпадающего списка при клике вне его
  document.addEventListener("click", function(e) {
    if (!e.target.closest("#city") && !e.target.closest(".suggestions")) {
      document.getElementById("city-suggestions").style.display = "none";
    }
  });

  // Обновление круга на карте
  function updateCircle(lat, lon) {
    const radius = parseInt(document.getElementById("radius").value) * 1000;
    drawnItems.clearLayers();
    L.circle([lat, lon], { radius: radius, color: '#3388ff' }).addTo(drawnItems);
    map.fitBounds(drawnItems.getBounds());
  }

  // Поиск города
  function searchCity() {
    const cityInput = document.getElementById("city").value.trim();
    if (!cityInput) return;

    fetch(https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(cityInput)}&lang=de&filter=countrycode:de&limit=1&apiKey=${GEOAPIFY_KEY})
      .then(response => response.json())
      .then(data => {
        if (data.features && data.features.length > 0) {
          const [lon, lat] = data.features[0].geometry.coordinates;
          map.setView([lat, lon], 13);
          updateCircle(lat, lon);
        } else {
          alert("Stadt nicht gefunden");
        }
      })
      .catch(error => {
        console.error("Error searching city:", error);
        alert("Fehler bei der Suche");
      });
  }

  // Изменение радиуса
  document.getElementById("radius").addEventListener("change", function() {
    const layers = drawnItems.getLayers();
    if (layers.length > 0 && layers[0] instanceof L.Circle) {
      const center = layers[0].getLatLng();
      updateCircle(center.lat, center.lng);
    }
  });

  // Сохранение фильтров
  document.getElementById("save").addEventListener("click", function() {
    const selectedWebsites = Array.from(document.querySelectorAll('#websites input[type=checkbox]:checked'))
      .map(checkbox => checkbox.value);
    
    if (selectedWebsites.length === 0) {
      alert("Bitte wählen Sie mindestens eine Website aus");
      return;
    }

    const filters = {
      city: document.getElementById("city").value.trim(),
      radius: parseInt(document.getElementById("radius").value),
      price: {
        min: document.getElementById("price-min").value || null,
        max: document.getElementById("price-max").value || null
      },
      size: {
        min: document.getElementById("size-min").value || null,
        max: document.getElementById("size-max").value || null
      },
      tauschwohnung: document.getElementById("tauschwohnung").checked,
      wbs: document.getElementById("wbs").checked,
      websites: selectedWebsites,
      area: getAreaData()
    };

    tg.sendData(JSON.stringify(filters));
    tg.close();
  });

  // Получение данных о выделенной области
  function getAreaData() {
    const layers = drawnItems.getLayers();
    if (layers.length === 0) return null;
    
    const layer = layers[0];
    if (layer instanceof L.Circle) {
      const center = layer.getLatLng();
      return {
        type: "circle",
        center: [center.lat, center.lng],
        radius: layer.getRadius()
      };
    } else if (layer instanceof L.Polygon) {
      const latlngs = layer.getLatLngs()[0]; // Получаем массив точек
      return {
        type: "polygon",
        coordinates: latlngs.map(latlng => [latlng.lat, latlng.lng])
      };
    }
    return null;
  }

  // Кнопка определения местоположения
  L.control.locate({
    position: 'topleft',
    strings: {
      title: "Mein Standort"
    },
    locateOptions: {
      maxZoom: 13
    }
  }).addTo(map);
</script>
</body>
</html>
